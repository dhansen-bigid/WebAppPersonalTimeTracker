<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Relationship Intel</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,300;0,400;0,500;1,400&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --bg:#0a0c0f; --bg2:#111418; --bg3:#181c22;
  --border:#242830; --border2:#2e3440;
  --text:#e8eaf0; --text2:#8b92a0; --text3:#555d6b;
  --accent:#4f8ef7; --accent-dim:#1e3a6e;
  --green:#3ecf8e; --green-dim:#0f3326;
  --amber:#f59e0b; --amber-dim:#3d2800;
  --red:#f05252; --red-dim:#3d1010;
  --purple:#a78bfa; --purple-dim:#2e1f5e;
  --mono:"IBM Plex Mono",monospace; --sans:"IBM Plex Sans",sans-serif;
  --radius:4px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:13px}
body{font-family:var(--sans);background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}

.screen{display:none;min-height:100vh}
.screen.active{display:flex;flex-direction:column}

/* ‚îÄ‚îÄ SETUP ‚îÄ‚îÄ */
#screen-setup{align-items:center;justify-content:center;padding:40px 20px;background:var(--bg)}
.setup-card{width:100%;max-width:520px;border:1px solid var(--border2);background:var(--bg2)}
.setup-logo{padding:28px 32px 20px;border-bottom:1px solid var(--border)}
.wordmark{font-family:var(--mono);font-size:1.1rem;font-weight:500;color:var(--text);letter-spacing:-0.02em}
.wordmark span{color:var(--accent)}
.tagline{font-size:11px;color:var(--text3);font-family:var(--mono);margin-top:4px;letter-spacing:0.06em;text-transform:uppercase}
.setup-body{padding:24px 32px}
.field-group{margin-bottom:14px}
.field-label{display:block;font-family:var(--mono);font-size:10px;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-bottom:5px}
.field-input{width:100%;background:var(--bg3);border:1px solid var(--border2);color:var(--text);font-family:var(--mono);font-size:11px;padding:8px 12px;outline:none;border-radius:var(--radius);transition:border-color 0.15s}
.field-input:focus{border-color:var(--accent)}
.field-input::placeholder{color:var(--text3)}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.btn-primary{width:100%;padding:10px;background:var(--accent);color:#fff;border:none;font-family:var(--mono);font-size:11px;font-weight:500;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;border-radius:var(--radius);transition:opacity 0.15s;margin-top:6px}
.btn-primary:hover{opacity:0.88}
.setup-note{margin-top:12px;padding:10px 14px;background:var(--bg3);border:1px solid var(--border2);border-radius:var(--radius);font-size:11px;color:var(--text3);font-family:var(--mono)}
.setup-error{margin-top:10px;padding:10px 14px;background:var(--red-dim);border:1px solid var(--red);border-radius:var(--radius);font-size:11px;color:var(--red);display:none}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
#screen-loading{align-items:center;justify-content:center;gap:20px}
.loading-bar-wrap{width:320px;height:2px;background:var(--border2);border-radius:1px;overflow:hidden}
.loading-bar{height:100%;background:var(--accent);width:0%;transition:width 0.3s ease;border-radius:1px}
.loading-status{font-family:var(--mono);font-size:11px;color:var(--text3);text-align:center;letter-spacing:0.06em}
.loading-title{font-family:var(--mono);font-size:13px;color:var(--text2)}

/* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
#screen-app{flex-direction:column}
.topbar{display:flex;align-items:center;height:44px;padding:0 20px;background:var(--bg2);border-bottom:1px solid var(--border);gap:16px;flex-shrink:0;position:sticky;top:0;z-index:100}
.topbar-wordmark{font-family:var(--mono);font-size:12px;font-weight:500;color:var(--text);white-space:nowrap;flex-shrink:0}
.topbar-wordmark span{color:var(--accent)}
.topbar-divider{width:1px;height:20px;background:var(--border2);flex-shrink:0}
.topbar-user{font-family:var(--mono);font-size:10px;color:var(--text3);flex-shrink:0}
.topbar-nav{display:flex;gap:2px;flex:1}
.nav-btn{padding:5px 14px;background:transparent;border:none;font-family:var(--mono);font-size:10px;letter-spacing:0.08em;text-transform:uppercase;color:var(--text3);cursor:pointer;border-radius:var(--radius);transition:all 0.12s;white-space:nowrap}
.nav-btn:hover{color:var(--text);background:var(--bg3)}
.nav-btn.active{color:var(--accent);background:var(--accent-dim)}
.topbar-controls{display:flex;gap:6px;align-items:center;flex-shrink:0}
.ctrl-select{background:var(--bg3);border:1px solid var(--border2);color:var(--text2);font-family:var(--mono);font-size:10px;padding:4px 8px;border-radius:var(--radius);cursor:pointer;outline:none}
.btn-sm{padding:5px 10px;background:transparent;border:1px solid var(--border2);color:var(--text3);font-family:var(--mono);font-size:10px;letter-spacing:0.06em;text-transform:uppercase;cursor:pointer;border-radius:var(--radius);transition:all 0.12s;white-space:nowrap}
.btn-sm:hover{border-color:var(--accent);color:var(--accent)}
.btn-sm.danger:hover{border-color:var(--red);color:var(--red)}

.view{display:none;flex:1;overflow-y:auto;padding:20px}
.view.active{display:block}

/* ‚îÄ‚îÄ KPI ‚îÄ‚îÄ */
.kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:1px;background:var(--border);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:18px}
.kpi-tile{background:var(--bg2);padding:14px 18px;position:relative}
.kpi-tile::after{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.kpi-tile:nth-child(1)::after{background:var(--accent)}
.kpi-tile:nth-child(2)::after{background:var(--green)}
.kpi-tile:nth-child(3)::after{background:var(--amber)}
.kpi-tile:nth-child(4)::after{background:var(--red)}
.kpi-tile:nth-child(5)::after{background:var(--text3)}
.kpi-label{font-family:var(--mono);font-size:9px;letter-spacing:0.12em;text-transform:uppercase;color:var(--text3);margin-bottom:7px}
.kpi-value{font-family:var(--mono);font-size:1.6rem;font-weight:500;color:var(--text);line-height:1}
.kpi-sub{font-size:10px;color:var(--text3);margin-top:4px;font-family:var(--mono)}

.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px}
.grid-3{display:grid;grid-template-columns:2fr 1fr 1fr;gap:14px;margin-bottom:14px}

.panel{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.panel-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--border);background:var(--bg3)}
.panel-title{font-family:var(--mono);font-size:10px;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3)}
.panel-meta{font-family:var(--mono);font-size:10px;color:var(--text3)}
.panel-body{padding:14px}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.tbl-wrap{overflow-x:auto}
table.acct-tbl{width:100%;border-collapse:collapse;font-size:12px}
.acct-tbl th{font-family:var(--mono);font-size:9px;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);padding:8px 10px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap;cursor:pointer;user-select:none;background:var(--bg3)}
.acct-tbl th:hover{color:var(--text2)}
.acct-tbl th.sort-asc::after{content:' ‚Üë';color:var(--accent)}
.acct-tbl th.sort-desc::after{content:' ‚Üì';color:var(--accent)}
.acct-tbl th.no-sort{cursor:default}
.acct-tbl th.no-sort:hover{color:var(--text3)}
.acct-tbl td{padding:8px 10px;border-bottom:1px solid var(--border);vertical-align:middle}
.acct-tbl tr:last-child td{border-bottom:none}
.acct-tbl tr:hover td{background:rgba(255,255,255,0.02)}
.acct-tbl tr.selected td{background:rgba(79,142,247,0.06)}
.acct-tbl tr.row-ignored{opacity:0.35}

.td-org{font-weight:500;color:var(--text)}
.td-domain{font-family:var(--mono);font-size:10px;color:var(--text3)}
.bar-wrap{display:flex;align-items:center;gap:7px}
.bar-track{width:70px;height:4px;background:var(--border2);border-radius:2px;overflow:hidden;flex-shrink:0}
.bar-fill{height:100%;background:var(--accent);border-radius:2px;opacity:0.8}
.num-val{font-family:var(--mono);font-size:11px;color:var(--text2);white-space:nowrap}
.num-dim{color:var(--text3)}

/* status badges */
.badge{display:inline-block;font-family:var(--mono);font-size:9px;padding:2px 7px;border-radius:2px;letter-spacing:0.06em;text-transform:uppercase;border:1px solid;cursor:pointer;user-select:none;transition:all 0.12s}
.badge-customer{color:var(--green);border-color:var(--green);background:var(--green-dim)}
.badge-prospect{color:var(--amber);border-color:var(--amber);background:var(--amber-dim)}
.badge-partner{color:var(--purple);border-color:var(--purple);background:var(--purple-dim)}
.badge-ignore{color:var(--text3);border-color:var(--border2);background:var(--bg);text-decoration:line-through}
.badge-unknown{color:var(--text3);border-color:var(--border2);background:var(--bg3)}

.dot{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:5px;vertical-align:middle;flex-shrink:0}
.dot-hot{background:var(--green);box-shadow:0 0 4px var(--green)}
.dot-warm{background:var(--amber)}
.dot-cold{background:var(--text3)}

.deal-input{background:transparent;border:none;border-bottom:1px solid var(--border2);color:var(--text2);font-family:var(--mono);font-size:11px;width:88px;padding:2px 4px;outline:none;transition:border-color 0.12s}
.deal-input:focus{border-color:var(--accent)}
.deal-input::placeholder{color:var(--text3)}

/* checkbox */
.row-check{width:14px;height:14px;accent-color:var(--accent);cursor:pointer}
.th-check{width:32px}

/* ‚îÄ‚îÄ BULK ACTION BAR ‚îÄ‚îÄ */
.bulk-bar{
  display:none;align-items:center;gap:10px;padding:8px 14px;
  background:var(--accent-dim);border:1px solid var(--accent);
  border-radius:var(--radius);margin-bottom:10px;
  font-family:var(--mono);font-size:11px;color:var(--text2);
}
.bulk-bar.visible{display:flex}
.bulk-bar-count{font-weight:500;color:var(--accent);margin-right:4px}
.bulk-label-btn{padding:4px 10px;background:transparent;border:1px solid var(--border2);color:var(--text2);font-family:var(--mono);font-size:10px;text-transform:uppercase;letter-spacing:0.06em;cursor:pointer;border-radius:var(--radius);transition:all 0.12s}
.bulk-label-btn:hover{border-color:var(--text2);color:var(--text)}
.bulk-label-btn.b-customer:hover{border-color:var(--green);color:var(--green)}
.bulk-label-btn.b-prospect:hover{border-color:var(--amber);color:var(--amber)}
.bulk-label-btn.b-partner:hover{border-color:var(--purple);color:var(--purple)}
.bulk-label-btn.b-ignore:hover{border-color:var(--red);color:var(--red)}
.bulk-label-btn.b-unknown:hover{border-color:var(--text3);color:var(--text3)}
.bulk-clear{margin-left:auto;background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px}
.bulk-clear:hover{color:var(--text)}

/* ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ */
.filter-bar{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.search-input{flex:1;min-width:180px;max-width:280px;background:var(--bg3);border:1px solid var(--border2);color:var(--text);font-family:var(--mono);font-size:11px;padding:6px 10px;outline:none;border-radius:var(--radius);transition:border-color 0.12s}
.search-input:focus{border-color:var(--accent)}
.search-input::placeholder{color:var(--text3)}
.filter-chip{padding:4px 10px;background:var(--bg3);border:1px solid var(--border2);color:var(--text3);font-family:var(--mono);font-size:9px;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;border-radius:var(--radius);transition:all 0.12s;white-space:nowrap}
.filter-chip:hover{color:var(--text2);border-color:var(--text3)}
.filter-chip.active{color:var(--accent);border-color:var(--accent);background:var(--accent-dim)}
.result-count{font-family:var(--mono);font-size:10px;color:var(--text3);margin-left:auto}

/* ‚îÄ‚îÄ SIGNALS ‚îÄ‚îÄ */
.signal-grid{display:flex;flex-direction:column;gap:6px}
.signal-row{display:flex;align-items:center;gap:12px;padding:9px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius)}
.signal-row.hot{border-left:2px solid var(--green)}
.signal-row.cold{border-left:2px solid var(--red);opacity:0.75}
.signal-name{font-weight:500;font-size:12px;flex:1;min-width:0}
.signal-domain{font-family:var(--mono);font-size:10px;color:var(--text3)}
.signal-stats{font-family:var(--mono);font-size:10px;color:var(--text3);white-space:nowrap;text-align:right;line-height:1.8}
.signal-stats strong{color:var(--text2)}

.sect-hdr{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.sect-title{font-family:var(--mono);font-size:10px;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3)}
.sect-line{flex:1;height:1px;background:var(--border)}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.open{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:var(--radius);width:100%;max-width:580px;max-height:82vh;overflow-y:auto;padding:26px 30px}
.modal h2{font-family:var(--mono);font-size:13px;font-weight:500;color:var(--text);margin-bottom:18px}
.modal-close{float:right;background:none;border:none;color:var(--text3);cursor:pointer;font-size:16px;line-height:1;margin-top:-2px}
.modal-close:hover{color:var(--text)}
.guide-step{display:flex;gap:14px;margin-bottom:16px}
.guide-num{flex-shrink:0;width:20px;height:20px;border:1px solid var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:9px;color:var(--accent);margin-top:2px}
.guide-step h4{font-size:12px;font-weight:600;margin-bottom:4px}
.guide-step p{font-size:11px;color:var(--text2);line-height:1.6}
.guide-step a{color:var(--accent);text-decoration:none}
.guide-step a:hover{text-decoration:underline}
.guide-step code{font-family:var(--mono);background:var(--bg3);border:1px solid var(--border);padding:0 5px;border-radius:2px;font-size:10px;color:var(--amber)}
.guide-note{margin-top:16px;padding:12px 14px;background:var(--accent-dim);border:1px solid var(--accent);border-radius:var(--radius);font-size:11px;color:var(--text2);line-height:1.6}

@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.view.active .kpi-row{animation:fadeUp 0.3s ease both}
.view.active .panel{animation:fadeUp 0.32s ease both}

@media(max-width:900px){
  .kpi-row{grid-template-columns:repeat(3,1fr)}
  .grid-2,.grid-3{grid-template-columns:1fr}
  .topbar-nav{display:none}
}
@media(max-width:600px){
  .kpi-row{grid-template-columns:repeat(2,1fr)}
  .view{padding:12px}
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê SETUP SCREEN ‚ïê‚ïê‚ïê -->
<div id="screen-setup" class="screen active">
  <div class="setup-card">
    <div class="setup-logo">
      <div class="wordmark">relationship<span>.</span>intel</div>
      <div class="tagline">Calendar-driven account intelligence ¬∑ v3</div>
    </div>
    <div class="setup-body">
      <div class="field-group">
        <label class="field-label">Lookback Window</label>
        <select id="inp-lookback" class="field-input">
          <option value="90">90 days</option>
          <option value="180">6 months</option>
          <option value="365" selected>12 months</option>
          <option value="540">18 months</option>
        </select>
      </div>
      <button class="btn-primary" onclick="startAuth()">Sign in with Google &amp; Load Calendar</button>
      <div class="setup-note">
        Read-only calendar access ¬∑ all data stays in your browser ¬∑ tags saved locally
        <br><a href="#" onclick="openGuide();return false;" style="color:var(--accent)">Setup guide for admins ‚Üí</a>
      </div>
      <div class="setup-error" id="setup-error"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê LOADING SCREEN ‚ïê‚ïê‚ïê -->
<div id="screen-loading" class="screen">
  <div class="loading-title">Loading calendar data‚Ä¶</div>
  <div class="loading-bar-wrap"><div class="loading-bar" id="loading-bar"></div></div>
  <div class="loading-status" id="loading-status">Authenticating‚Ä¶</div>
</div>

<!-- ‚ïê‚ïê‚ïê APP SCREEN ‚ïê‚ïê‚ïê -->
<div id="screen-app" class="screen">

  <div class="topbar">
    <div class="topbar-wordmark">rel<span>.</span>intel</div>
    <div class="topbar-divider"></div>
    <div class="topbar-user" id="topbar-user"></div>
    <div class="topbar-divider"></div>
    <div class="topbar-nav">
      <button class="nav-btn active" onclick="showView('overview',this)">Overview</button>
      <button class="nav-btn" onclick="showView('accounts',this)">Accounts</button>
      <button class="nav-btn" onclick="showView('signals',this)">Signals</button>
      <button class="nav-btn" onclick="showView('trends',this)">Trends</button>
    </div>
    <div class="topbar-controls" style="margin-left:auto">
      <select class="ctrl-select" id="window-select" onchange="renderKPIs()">
        <option value="90">90 days</option>
        <option value="180">6 months</option>
        <option value="365" selected>12 months</option>
        <option value="540">18 months</option>
      </select>
      <button class="btn-sm" onclick="exportCSV()">CSV</button>
      <button class="btn-sm" onclick="exportSnapshot()">Share Snapshot</button>
      <button class="btn-sm" onclick="exportTags()">Save Tags</button>
      <button class="btn-sm" onclick="document.getElementById('import-input').click()">Load Tags</button>
      <input id="import-input" type="file" accept=".json" style="display:none" onchange="importTags(event)">
      <button class="btn-sm" onclick="openGuide()">Guide</button>
      <button class="btn-sm danger" onclick="signOut()">Sign Out</button>
    </div>
  </div>

  <!-- OVERVIEW -->
  <div id="view-overview" class="view active">
    <div class="kpi-row" id="kpi-row"></div>
    <div class="grid-3">
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Top 20 by hours</span>
          <span class="panel-meta" id="ov-window-label"></span>
        </div>
        <div class="panel-body"><canvas id="ch-top-time"></canvas></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:14px">
        <div class="panel" style="flex:1">
          <div class="panel-header"><span class="panel-title">Top 15 by meetings</span></div>
          <div class="panel-body"><canvas id="ch-top-mtgs"></canvas></div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:14px">
        <div class="panel" style="flex:1">
          <div class="panel-header"><span class="panel-title">Monthly hours</span></div>
          <div class="panel-body"><canvas id="ch-monthly"></canvas></div>
        </div>
      </div>
    </div>

    <!-- SEGMENT BREAKDOWN ROW -->
    <div class="grid-2">
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Hours by segment</span>
          <span class="panel-meta">customer ¬∑ prospect ¬∑ partner ¬∑ unknown</span>
        </div>
        <div class="panel-body" style="display:flex;align-items:center;gap:24px">
          <div style="width:160px;height:160px;flex-shrink:0"><canvas id="ch-seg-hours"></canvas></div>
          <div id="seg-hours-legend" style="font-family:var(--mono);font-size:11px;line-height:2.2;color:var(--text2)"></div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Meetings by segment</span>
          <span class="panel-meta">customer ¬∑ prospect ¬∑ partner ¬∑ unknown</span>
        </div>
        <div class="panel-body" style="display:flex;align-items:center;gap:24px">
          <div style="width:160px;height:160px;flex-shrink:0"><canvas id="ch-seg-mtgs"></canvas></div>
          <div id="seg-mtgs-legend" style="font-family:var(--mono);font-size:11px;line-height:2.2;color:var(--text2)"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ACCOUNTS -->
  <div id="view-accounts" class="view">
    <div class="filter-bar">
      <input type="text" class="search-input" id="acct-search" placeholder="Search account or domain‚Ä¶" oninput="renderAccounts()">
      <button class="filter-chip active" data-status="all"      onclick="setStatusFilter('all',this)">All</button>
      <button class="filter-chip" data-status="customer"        onclick="setStatusFilter('customer',this)">Customer</button>
      <button class="filter-chip" data-status="prospect"        onclick="setStatusFilter('prospect',this)">Prospect</button>
      <button class="filter-chip" data-status="partner"         onclick="setStatusFilter('partner',this)">Partner</button>
      <button class="filter-chip" data-status="unknown"         onclick="setStatusFilter('unknown',this)">Unknown</button>
      <button class="filter-chip" data-status="active90"        onclick="setStatusFilter('active90',this)">Active 90d</button>
      <button class="filter-chip" data-status="ignored"         onclick="setStatusFilter('ignored',this)">Ignored</button>
      <span class="result-count" id="acct-count"></span>
    </div>

    <!-- BULK ACTION BAR -->
    <div class="bulk-bar" id="bulk-bar">
      <span><span class="bulk-bar-count" id="bulk-count">0</span> selected ‚Äî label as:</span>
      <button class="bulk-label-btn b-customer" onclick="bulkSetStatus('customer')">Customer</button>
      <button class="bulk-label-btn b-prospect" onclick="bulkSetStatus('prospect')">Prospect</button>
      <button class="bulk-label-btn b-partner"  onclick="bulkSetStatus('partner')">Partner</button>
      <button class="bulk-label-btn b-ignore"   onclick="bulkSetStatus('ignore')">Ignore</button>
      <button class="bulk-label-btn b-unknown"  onclick="bulkSetStatus('unknown')">Unknown</button>
      <button class="bulk-clear" onclick="clearSelection()" title="Clear selection">‚úï</button>
    </div>

    <div class="panel">
      <div class="tbl-wrap">
        <table class="acct-tbl" id="acct-tbl">
          <thead>
            <tr>
              <th class="no-sort th-check">
                <input type="checkbox" class="row-check" id="check-all" onclick="toggleSelectAll(this)">
              </th>
              <th onclick="sortAccounts('org')">Account</th>
              <th onclick="sortAccounts('hours_window')">Hours</th>
              <th onclick="sortAccounts('mtgs_window')">Meetings</th>
              <th onclick="sortAccounts('hours_90d')">Hours (90d)</th>
              <th onclick="sortAccounts('mtgs_90d')">Mtgs (90d)</th>
              <th onclick="sortAccounts('last_meeting')">Last Meeting</th>
              <th class="no-sort">Status</th>
              <th class="no-sort">Deal $</th>
            </tr>
          </thead>
          <tbody id="acct-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- SIGNALS -->
  <div id="view-signals" class="view">
    <div class="grid-2" style="align-items:start">
      <div>
        <div class="sect-hdr">
          <span class="sect-title">üî• High Velocity</span>
          <div class="sect-line"></div>
          <span style="font-family:var(--mono);font-size:9px;color:var(--text3)">3+ mtgs in 90d</span>
        </div>
        <div class="signal-grid" id="hot-list"></div>
      </div>
      <div>
        <div class="sect-hdr">
          <span class="sect-title">‚ùÑÔ∏è Gone Cold</span>
          <div class="sect-line"></div>
          <span style="font-family:var(--mono);font-size:9px;color:var(--text3)">active in window ¬∑ 0 in 90d</span>
        </div>
        <div class="signal-grid" id="cold-list"></div>
      </div>
    </div>
    <div style="margin-top:20px">
      <div class="sect-hdr">
        <span class="sect-title">üíº Pipeline Influence</span>
        <div class="sect-line"></div>
        <span style="font-family:var(--mono);font-size:9px;color:var(--text3)">accounts with deal $ tagged</span>
      </div>
      <div class="panel"><div class="panel-body"><div id="pipeline-list"></div></div></div>
    </div>
  </div>

  <!-- TRENDS -->
  <div id="view-trends" class="view">
    <div class="grid-2">
      <div class="panel">
        <div class="panel-header"><span class="panel-title">External meetings / month</span></div>
        <div class="panel-body"><canvas id="ch-trend-mtgs"></canvas></div>
      </div>
      <div class="panel">
        <div class="panel-header"><span class="panel-title">External hours / month</span></div>
        <div class="panel-body"><canvas id="ch-trend-hrs"></canvas></div>
      </div>
    </div>
    <div class="panel" style="margin-bottom:14px">
      <div class="panel-header">
        <span class="panel-title">Top 15 ‚Äî full window (grey) vs 90d (blue)</span>
      </div>
      <div class="panel-body" id="top15-bars"></div>
    </div>
  </div>

</div><!-- /screen-app -->

<!-- ‚ïê‚ïê‚ïê GUIDE MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="guide-modal">
  <div class="modal">
    <h2>Google Cloud Setup Guide <button class="modal-close" onclick="closeGuide()">‚úï</button></h2>
    <div class="guide-step">
      <div class="guide-num">1</div>
      <div><h4>Create a Google Cloud Project</h4>
      <p>Go to <a href="https://console.cloud.google.com" target="_blank">console.cloud.google.com</a> ‚Üí project dropdown ‚Üí <strong>New Project</strong>. Name it (e.g. <em>Relationship Intel</em>) and create it.</p></div>
    </div>
    <div class="guide-step">
      <div class="guide-num">2</div>
      <div><h4>Enable the Google Calendar API</h4>
      <p><strong>APIs &amp; Services ‚Üí Library</strong>. Search <em>Google Calendar API</em> ‚Üí Enable.</p></div>
    </div>
    <div class="guide-step">
      <div class="guide-num">3</div>
      <div><h4>Configure the OAuth Consent Screen</h4>
      <p><strong>APIs &amp; Services ‚Üí OAuth consent screen</strong>. Choose <strong>External</strong>. Fill in app name and your email. Add scope <code>calendar.readonly</code>. Under <em>Test users</em>, add every teammate's Google email address. Save.</p></div>
    </div>
    <div class="guide-step">
      <div class="guide-num">4</div>
      <div><h4>Create an OAuth Client ID</h4>
      <p><strong>Credentials ‚Üí Create Credentials ‚Üí OAuth client ID ‚Üí Web application</strong>. Under <em>Authorized JavaScript origins</em> add your GitHub Pages base URL, e.g. <code>https://dhansen-bigid.github.io</code>. Copy the Client ID and paste it into the <code>GOOGLE_CLIENT_ID</code> constant at the top of this file's script block.</p></div>
    </div>
    <div class="guide-step">
      <div class="guide-num">5</div>
      <div><h4>Tags &amp; Persistence</h4>
      <p>Tags (status, deal $) save to each person's browser automatically. To survive a cache clear or move to a new device: use <strong>Save Tags</strong> to download a JSON backup, and <strong>Load Tags</strong> to restore it. Share the same JSON with a manager to roll up team-level pipeline views.</p></div>
    </div>
    <div class="guide-note">
      <strong>Privacy:</strong> Read-only calendar access only. No data leaves the browser. The Client ID in the source code is safe to expose publicly ‚Äî it cannot be used to access anyone's data without their explicit Google consent.
    </div>
  </div>
</div>

<script src="https://accounts.google.com/gsi/client" async></script>
<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ‚ñ∂ CONFIG ‚Äî set your Client ID once here
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const GOOGLE_CLIENT_ID = '556868937449-mc08d7g147b7sing51as61cqrmrp2h9m.apps.googleusercontent.com';
// ^ paste your OAuth Client ID above ‚Äî teammates never need to touch this

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const STORAGE_KEY = 'rel_intel_tags_v3';
const CONFIG_KEY  = 'rel_intel_cfg_v3';
const INTERNAL_SKIP = ['calendar-notification@google.com'];
const STATUS_CYCLE  = ['unknown','prospect','customer','partner','ignore'];

let ACCESS_TOKEN    = null;
let USER_EMAIL      = '';
let INTERNAL_DOMAIN = 'bigid.com';
let LOOKBACK_DAYS   = 365;
let allAccounts     = [];
let tags            = {};
let monthlyData     = [];
let acctSortKey     = 'hours_window';
let acctSortDir     = -1;
let statusFilter    = 'all';
let selectedDomains = new Set();
const charts        = {};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PERSISTENCE ‚Äî localStorage
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function saveTags()  { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(tags)); } catch(e){} }
function loadTags()  { try { tags = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}'); } catch(e){ tags={}; } }
function saveConfig(lookback) {
  try { localStorage.setItem(CONFIG_KEY, JSON.stringify({lookback})); } catch(e){}
}
function loadConfig() {
  try {
    const c = JSON.parse(localStorage.getItem(CONFIG_KEY)||'{}');
    if (c.lookback) document.getElementById('inp-lookback').value = c.lookback;
  } catch(e){}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PERSISTENCE ‚Äî export / import JSON
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function exportTags() {
  const payload = { version:3, email: USER_EMAIL, exported: new Date().toISOString(), tags };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const a = Object.assign(document.createElement('a'), {
    href: URL.createObjectURL(blob),
    download: `rel_intel_tags_${new Date().toISOString().slice(0,10)}.json`
  });
  a.click();
}

function importTags(evt) {
  const file = evt.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const parsed = JSON.parse(e.target.result);
      tags = parsed.tags || parsed; // support both wrapped and raw
      saveTags();
      renderAccounts();
      renderSignals();
      renderKPIs();
      showToast('Tags loaded successfully');
    } catch(err) {
      showToast('Error reading file: ' + err.message, true);
    }
    evt.target.value = '';
  };
  reader.readAsText(file);
}

function showToast(msg, isError=false) {
  const t = Object.assign(document.createElement('div'), {textContent: msg});
  Object.assign(t.style, {
    position:'fixed', bottom:'20px', right:'20px', zIndex:9999,
    background: isError ? 'var(--red-dim)' : 'var(--green-dim)',
    border: `1px solid ${isError ? 'var(--red)' : 'var(--green)'}`,
    color: isError ? 'var(--red)' : 'var(--green)',
    fontFamily:'var(--mono)', fontSize:'11px', padding:'10px 16px',
    borderRadius:'var(--radius)', transition:'opacity 0.4s'
  });
  document.body.appendChild(t);
  setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(), 400); }, 2500);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SCREEN / VIEW
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-'+id).classList.add('active');
}
function showView(name, btn) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('view-'+name).classList.add('active');
  if (btn) btn.classList.add('active');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AUTH
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function startAuth() {
  const lookback = parseInt(document.getElementById('inp-lookback').value) || 365;
  const clientId = GOOGLE_CLIENT_ID;

  if (!clientId || clientId.includes('YOUR_CLIENT_ID')) {
    showError('Client ID not configured. Open the file and set GOOGLE_CLIENT_ID at the top of the script.');
    return;
  }

  LOOKBACK_DAYS = lookback;
  saveConfig(lookback);

  const client = google.accounts.oauth2.initTokenClient({
    client_id: clientId,
    scope: 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/userinfo.email',
    callback: resp => {
      if (resp.error) { showError('Google auth error: ' + resp.error); return; }
      ACCESS_TOKEN = resp.access_token;
      fetchUserInfo().then(() => {
        INTERNAL_DOMAIN = USER_EMAIL.split('@')[1]?.toLowerCase() || 'bigid.com';
        loadCalendarData();
      });
    },
    error_callback: err => showError('Auth failed: ' + (err.message || err.type || 'Unknown'))
  });
  client.requestAccessToken({ prompt: 'consent' });
}

async function fetchUserInfo() {
  const r = await fetch('https://www.googleapis.com/oauth2/v3/userinfo',
    { headers: { Authorization: `Bearer ${ACCESS_TOKEN}` } });
  const d = await r.json();
  USER_EMAIL = d.email || '';
}

function signOut() {
  ACCESS_TOKEN = null; USER_EMAIL = ''; allAccounts = [];
  Object.keys(charts).forEach(k => { try{charts[k].destroy();}catch(e){} delete charts[k]; });
  showScreen('setup');
}

function showError(msg) {
  const el = document.getElementById('setup-error');
  el.textContent = msg; el.style.display = 'block';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CALENDAR LOADING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function loadCalendarData() {
  showScreen('loading');
  loadTags();
  const now    = new Date();
  const cutoff = new Date(now - LOOKBACK_DAYS * 864e5);
  const events = [];
  setProgress(5, 'Fetching events‚Ä¶');
  let pageToken = null, page = 0;
  do {
    const params = new URLSearchParams({
      timeMin: cutoff.toISOString(), timeMax: now.toISOString(),
      singleEvents:'true', maxResults:'2500', orderBy:'startTime'
    });
    if (pageToken) params.set('pageToken', pageToken);
    const r = await fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events?${params}`,
      { headers: { Authorization: `Bearer ${ACCESS_TOKEN}` } });
    const d = await r.json();
    if (d.error) { showError('Calendar API: ' + d.error.message); showScreen('setup'); return; }
    (d.items||[]).forEach(e => events.push(e));
    pageToken = d.nextPageToken || null;
    page++;
    setProgress(5 + Math.min(page*8,60), `Loaded ${events.length} events‚Ä¶`);
  } while (pageToken);
  setProgress(70, 'Processing‚Ä¶');
  processEvents(events, now);
  setProgress(100, 'Done');
  await new Promise(r => setTimeout(r, 250));
  buildApp();
  showScreen('app');
}

function setProgress(pct, msg) {
  document.getElementById('loading-bar').style.width = pct + '%';
  document.getElementById('loading-status').textContent = msg;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EVENT PROCESSING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function extractDomain(email) {
  if (!email || !email.includes('@')) return null;
  const host = email.split('@')[1].toLowerCase();
  const parts = host.split('.');
  return parts.length > 2 ? parts.slice(-2).join('.') : host;
}
function normOrg(domain) {
  const n = domain.split('.')[0];
  return n.charAt(0).toUpperCase() + n.slice(1);
}
function clampDur(raw) { return raw<=0?0:Math.min(Math.max(raw,15),180); }

function processEvents(events, now) {
  const d90 = new Date(now - 90*864e5);
  const buckets={}, monthly={};
  for (const e of events) {
    if (e.status==='cancelled') continue;
    if (e.eventType==='workingLocation') continue;
    const title = (e.summary||'').toLowerCase();
    if (title.includes('ooo')||title.includes('out of office')) continue;
    const startStr = (e.start||{}).dateTime||(e.start||{}).date;
    const endStr   = (e.end  ||{}).dateTime||(e.end  ||{}).date;
    if (!startStr) continue;
    const startDt = new Date(startStr);
    const endDt   = new Date(endStr||startStr);
    const durMin  = clampDur(Math.round((endDt-startDt)/60000));
    if (!durMin) continue;
    const attendees = e.attendees||[];

    // Count real (non-resource) attendees for ratio check
    const realAttendees = attendees.filter(a => !a.resource);
    const totalReal = realAttendees.length;

    // Build a count of attendees per external domain
    const domainCounts = {};
    for (const a of realAttendees) {
      if (a.self) continue;
      const email = (a.email||'').toLowerCase();
      if (INTERNAL_SKIP.some(s=>email.includes(s))) continue;
      const dom = extractDomain(email);
      if (!dom||dom===INTERNAL_DOMAIN) continue;
      if (/google|zoom|calendar/.test(dom)) continue;
      domainCounts[dom] = (domainCounts[dom]||0) + 1;
    }

    // Filter out incidental domains:
    // If a meeting has 8+ real attendees, a domain must represent at least 15%
    // of total attendees to count as a real external engagement.
    // Small meetings (< 8 people) are always counted in full.
    const LARGE_MEETING_THRESHOLD = 8;
    const MIN_RATIO = 0.15;
    const extDoms = new Set(
      Object.entries(domainCounts)
        .filter(([, count]) =>
          totalReal < LARGE_MEETING_THRESHOLD || (count / totalReal) >= MIN_RATIO
        )
        .map(([dom]) => dom)
    );

    if (!extDoms.size) continue;
    const mk = startDt.toISOString().slice(0,7);
    if (!monthly[mk]) monthly[mk]={mtgs:0,min:0};
    monthly[mk].mtgs++; monthly[mk].min+=durMin;
    for (const dom of extDoms) {
      if (!buckets[dom]) buckets[dom]={
        org:normOrg(dom), domain:dom, first_seen:startDt, last_meeting:startDt,
        hours_window:0, mtgs_window:0, hours_90d:0, mtgs_90d:0, titles:new Set()
      };
      const b=buckets[dom];
      if (startDt<b.first_seen)   b.first_seen=startDt;
      if (startDt>b.last_meeting) b.last_meeting=startDt;
      b.hours_window+=durMin/60; b.mtgs_window++;
      if (startDt>=d90){b.hours_90d+=durMin/60; b.mtgs_90d++;}
      if (e.summary) b.titles.add(e.summary);
    }
  }
  allAccounts = Object.values(buckets).map(b=>({
    ...b,
    hours_window: Math.round(b.hours_window*10)/10,
    hours_90d:    Math.round(b.hours_90d   *10)/10,
    titles: [...b.titles].slice(0,8)
  }));
  allAccounts.sort((a,b)=>b.hours_window-a.hours_window);
  monthlyData = Object.keys(monthly).sort().map(m=>({
    month:m, mtgs:monthly[m].mtgs,
    hours:Math.round(monthly[m].min/60*10)/10
  }));
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BUILD APP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildApp() {
  document.getElementById('topbar-user').textContent = `${USER_EMAIL} ¬∑ ${INTERNAL_DOMAIN}`;
  renderKPIs();
  renderOverviewCharts();
  renderSegmentCharts();
  renderAccounts();
  renderSignals();
  renderTrends();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   KPIs
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderKPIs() {
  const visible = allAccounts.filter(a => (tags[a.domain]?.status||'unknown') !== 'ignore');
  const hrs   = visible.reduce((s,a)=>s+a.hours_window,0).toFixed(0);
  const mtgs  = visible.reduce((s,a)=>s+a.mtgs_window,0);
  const a90   = visible.filter(a=>a.mtgs_90d>0).length;
  const top   = visible[0]?.org || '‚Äî';
  const kpis  = [
    {label:'Accounts',    value:visible.length, sub:'external orgs'},
    {label:'Total Hours', value:hrs+'h',        sub:'relationship time'},
    {label:'Meetings',    value:mtgs,           sub:'external meetings'},
    {label:'Active (90d)',value:a90,            sub:'orgs with recent activity'},
    {label:'Top Account', value:top,            sub:'by hours'},
  ];
  document.getElementById('kpi-row').innerHTML = kpis.map(k=>`
    <div class="kpi-tile">
      <div class="kpi-label">${k.label}</div>
      <div class="kpi-value" style="font-size:${k.value.toString().length>8?'1rem':'1.6rem'}">${k.value}</div>
      <div class="kpi-sub">${k.sub}</div>
    </div>`).join('');
  document.getElementById('ov-window-label').textContent = LOOKBACK_DAYS+'d window';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CHARTS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const CD = {responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false}}};
const TK = {font:{family:"'IBM Plex Mono'",size:9},color:'#555d6b'};
function mkChart(id,cfg){
  if(charts[id]){try{charts[id].destroy();}catch(e){} delete charts[id];}
  const el=document.getElementById(id); if(!el)return;
  charts[id]=new Chart(el.getContext('2d'),cfg);
}

function renderOverviewCharts() {
  const vis = allAccounts.filter(a=>(tags[a.domain]?.status||'unknown')!=='ignore');
  const top20t = vis.slice(0,20);
  mkChart('ch-top-time',{type:'bar',data:{
    labels:top20t.map(a=>a.org),
    datasets:[{data:top20t.map(a=>a.hours_window),
      backgroundColor:top20t.map((_,i)=>i===0?'#4f8ef7':i<4?'#2a5fa8':'#242830'),
      borderWidth:0,borderRadius:2}]
  },options:{...CD,indexAxis:'y',aspectRatio:0.6,
    scales:{x:{grid:{color:'#181c22'},ticks:{...TK}},
            y:{grid:{display:false},ticks:{font:{family:"'IBM Plex Sans'",size:10},color:'#8b92a0'}}},
    plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>` ${ctx.raw}h ¬∑ ${top20t[ctx.dataIndex].mtgs_window} meetings`}}}
  }});

  const top15m=[...vis].sort((a,b)=>b.mtgs_window-a.mtgs_window).slice(0,15);
  mkChart('ch-top-mtgs',{type:'bar',data:{
    labels:top15m.map(a=>a.org),
    datasets:[{data:top15m.map(a=>a.mtgs_window),backgroundColor:'#1e3a6e',borderWidth:0,borderRadius:2}]
  },options:{...CD,indexAxis:'y',aspectRatio:0.55,
    scales:{x:{grid:{color:'#181c22'},ticks:{...TK}},
            y:{grid:{display:false},ticks:{font:{family:"'IBM Plex Sans'",size:10},color:'#8b92a0'}}}
  }});

  const last14=monthlyData.slice(-14);
  mkChart('ch-monthly',{type:'bar',data:{
    labels:last14.map(d=>d.month.slice(2)),
    datasets:[{data:last14.map(d=>d.hours),
      backgroundColor:last14.map((_,i)=>i===last14.length-1?'#4f8ef7':'#1e3a6e'),
      borderWidth:0,borderRadius:2}]
  },options:{...CD,aspectRatio:1.4,
    scales:{x:{grid:{display:false},ticks:{...TK,maxRotation:45}},
            y:{grid:{color:'#181c22'},ticks:{...TK}}}
  }});
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SEGMENT CHARTS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderSegmentCharts() {
  const SEG_ORDER  = ['customer','prospect','partner','unknown'];
  const SEG_COLORS = ['#3ecf8e','#f59e0b','#a78bfa','#2e3440'];
  const SEG_LABELS = ['Customer','Prospect','Partner','Unknown'];

  const vis = allAccounts.filter(a => (tags[a.domain]?.status||'unknown') !== 'ignore');

  // Aggregate hours and meetings per segment
  const hrs  = {customer:0, prospect:0, partner:0, unknown:0};
  const mtgs = {customer:0, prospect:0, partner:0, unknown:0};
  for (const a of vis) {
    const s = tags[a.domain]?.status || 'unknown';
    const key = SEG_ORDER.includes(s) ? s : 'unknown';
    hrs[key]  += a.hours_window;
    mtgs[key] += a.mtgs_window;
  }

  const totalHrs  = SEG_ORDER.reduce((s,k) => s + hrs[k],  0) || 1;
  const totalMtgs = SEG_ORDER.reduce((s,k) => s + mtgs[k], 0) || 1;

  function donutCfg(dataArr) {
    return {
      type: 'doughnut',
      data: {
        labels: SEG_LABELS,
        datasets: [{ data: dataArr, backgroundColor: SEG_COLORS, borderWidth: 0, hoverOffset: 4 }]
      },
      options: {
        responsive: true, maintainAspectRatio: true,
        cutout: '68%',
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.raw}` } }
        }
      }
    };
  }

  mkChart('ch-seg-hours', donutCfg(SEG_ORDER.map(k => Math.round(hrs[k] * 10) / 10)));
  mkChart('ch-seg-mtgs',  donutCfg(SEG_ORDER.map(k => mtgs[k])));

  // Custom legends
  function legendHTML(dataArr, suffix, total) {
    return SEG_ORDER.map((k, i) => {
      const val = dataArr[i];
      const pct = total > 0 ? Math.round(val / total * 100) : 0;
      return `<div style="display:flex;align-items:center;gap:8px">
        <div style="width:8px;height:8px;border-radius:50%;background:${SEG_COLORS[i]};flex-shrink:0"></div>
        <span style="color:var(--text2)">${SEG_LABELS[i]}</span>
        <span style="color:var(--text3);margin-left:auto;padding-left:12px">${val}${suffix} <span style="color:var(--text3);font-size:9px">(${pct}%)</span></span>
      </div>`;
    }).join('');
  }

  document.getElementById('seg-hours-legend').innerHTML =
    legendHTML(SEG_ORDER.map(k => Math.round(hrs[k] * 10) / 10), 'h', totalHrs);
  document.getElementById('seg-mtgs-legend').innerHTML =
    legendHTML(SEG_ORDER.map(k => mtgs[k]), '', totalMtgs);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SNAPSHOT EXPORT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function exportSnapshot() {
  const vis = allAccounts.filter(a => (tags[a.domain]?.status||'unknown') !== 'ignore');
  const top20 = vis.slice(0, 20);
  const maxH  = top20.length ? top20[0].hours_window : 1;

  const SEG_COLORS = { customer:'#3ecf8e', prospect:'#f59e0b', partner:'#a78bfa', unknown:'#2e3440' };
  const BADGE_BG   = { customer:'#0f3326', prospect:'#3d2800', partner:'#2e1f5e', unknown:'#181c22' };

  const segHrs  = {customer:0, prospect:0, partner:0, unknown:0};
  const segMtgs = {customer:0, prospect:0, partner:0, unknown:0};
  vis.forEach(a => {
    const s = tags[a.domain]?.status || 'unknown';
    const k = s in segHrs ? s : 'unknown';
    segHrs[k]  += a.hours_window;
    segMtgs[k] += a.mtgs_window;
  });

  const totalHrs  = Object.values(segHrs).reduce((s,v)=>s+v,0);
  const totalMtgs = Object.values(segMtgs).reduce((s,v)=>s+v,0);

  const segKeys = ['customer','prospect','partner','unknown'];
  const segLabels = ['Customer','Prospect','Partner','Unknown'];

  function segRows(dataObj, suffix) {
    return segKeys.map((k,i) => {
      const val = dataObj[k];
      const pct = totalHrs > 0 ? Math.round(val / (suffix==='h' ? totalHrs : totalMtgs) * 100) : 0;
      return `<tr>
        <td style="padding:6px 10px;display:flex;align-items:center;gap:8px">
          <div style="width:8px;height:8px;border-radius:50%;background:${SEG_COLORS[k]}"></div>
          ${segLabels[i]}
        </td>
        <td style="padding:6px 10px;font-family:monospace;text-align:right">${Math.round(val*10)/10}${suffix}</td>
        <td style="padding:6px 10px;font-family:monospace;text-align:right;color:#555d6b">${pct}%</td>
      </tr>`;
    }).join('');
  }

  const top20rows = top20.map(a => {
    const s = tags[a.domain]?.status || 'unknown';
    const barW = Math.round(a.hours_window / maxH * 100);
    return `<tr style="border-bottom:1px solid #242830">
      <td style="padding:7px 12px;font-weight:500">${a.org}</td>
      <td style="padding:7px 12px;font-family:monospace;font-size:11px;color:#555d6b">${a.domain}</td>
      <td style="padding:7px 12px">
        <div style="display:flex;align-items:center;gap:8px">
          <div style="width:80px;height:4px;background:#242830;border-radius:2px;overflow:hidden">
            <div style="height:100%;width:${barW}%;background:#4f8ef7;border-radius:2px"></div>
          </div>
          <span style="font-family:monospace;font-size:11px">${a.hours_window}h</span>
        </div>
      </td>
      <td style="padding:7px 12px;font-family:monospace;font-size:11px">${a.mtgs_window}</td>
      <td style="padding:7px 12px">
        <span style="font-family:monospace;font-size:9px;padding:2px 7px;border-radius:2px;
          border:1px solid ${SEG_COLORS[s]||'#2e3440'};
          color:${SEG_COLORS[s]||'#555d6b'};
          background:${BADGE_BG[s]||'#181c22'};
          text-transform:uppercase;letter-spacing:0.06em">${s}</span>
      </td>
      <td style="padding:7px 12px;font-family:monospace;font-size:11px;color:#555d6b">${fmtDate(a.last_meeting)}</td>
    </tr>`;
  }).join('');

  const last12 = monthlyData.slice(-12);
  const maxMonthH = Math.max(...last12.map(d=>d.hours), 1);
  const sparkBars = last12.map((d,i) => {
    const h = Math.round(d.hours / maxMonthH * 60);
    return `<div style="display:inline-flex;flex-direction:column;align-items:center;gap:4px;width:40px">
      <div style="font-family:monospace;font-size:9px;color:#555d6b">${d.hours}h</div>
      <div style="height:${h}px;min-height:2px;width:24px;
        background:${i===last12.length-1?'#4f8ef7':'#1e3a6e'};border-radius:2px"></div>
      <div style="font-family:monospace;font-size:9px;color:#555d6b">${d.month.slice(2)}</div>
    </div>`;
  }).join('');

  const now = new Date();
  const dateStr = now.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});

  const html = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Relationship Intel ‚Äî ${USER_EMAIL} ‚Äî ${dateStr}</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:"IBM Plex Sans",sans-serif;background:#0a0c0f;color:#e8eaf0;padding:0;font-size:13px;-webkit-font-smoothing:antialiased}
  .page{max-width:960px;margin:0 auto;padding:32px 24px}
  .hdr{border-bottom:2px solid #4f8ef7;padding-bottom:16px;margin-bottom:28px}
  .hdr h1{font-family:"IBM Plex Mono",monospace;font-size:1.1rem;font-weight:500;letter-spacing:-0.02em}
  .hdr h1 span{color:#4f8ef7}
  .hdr .meta{font-family:"IBM Plex Mono",monospace;font-size:10px;color:#555d6b;margin-top:5px;letter-spacing:0.06em;text-transform:uppercase}
  .kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:#242830;border:1px solid #242830;border-radius:4px;overflow:hidden;margin-bottom:24px}
  .kpi{background:#111418;padding:14px 18px;position:relative}
  .kpi::after{content:'';position:absolute;top:0;left:0;right:0;height:2px}
  .kpi:nth-child(1)::after{background:#4f8ef7}
  .kpi:nth-child(2)::after{background:#3ecf8e}
  .kpi:nth-child(3)::after{background:#f59e0b}
  .kpi:nth-child(4)::after{background:#555d6b}
  .kpi-lbl{font-family:"IBM Plex Mono",monospace;font-size:9px;letter-spacing:0.12em;text-transform:uppercase;color:#555d6b;margin-bottom:7px}
  .kpi-val{font-family:"IBM Plex Mono",monospace;font-size:1.5rem;font-weight:500;line-height:1}
  .kpi-sub{font-size:10px;color:#555d6b;margin-top:4px;font-family:"IBM Plex Mono",monospace}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
  .panel{background:#111418;border:1px solid #242830;border-radius:4px;overflow:hidden;margin-bottom:16px}
  .ph{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #242830;background:#181c22}
  .pt{font-family:"IBM Plex Mono",monospace;font-size:10px;letter-spacing:0.1em;text-transform:uppercase;color:#555d6b}
  .pb{padding:14px}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th{font-family:"IBM Plex Mono",monospace;font-size:9px;letter-spacing:0.1em;text-transform:uppercase;color:#555d6b;padding:8px 12px;text-align:left;border-bottom:1px solid #242830;background:#181c22}
  td{padding:7px 12px;border-bottom:1px solid #181c22;vertical-align:middle}
  .seg-row{display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid #181c22}
  .footer{margin-top:28px;padding-top:16px;border-top:1px solid #242830;font-family:"IBM Plex Mono",monospace;font-size:10px;color:#555d6b;text-align:center}
</style>
</head>
<body>
<div class="page">
  <div class="hdr">
    <h1>relationship<span>.</span>intel</h1>
    <div class="meta">${USER_EMAIL} ¬∑ Generated ${dateStr} ¬∑ ${LOOKBACK_DAYS}-day window</div>
  </div>

  <div class="kpi-row">
    <div class="kpi"><div class="kpi-lbl">Accounts</div><div class="kpi-val">${vis.length}</div><div class="kpi-sub">external orgs</div></div>
    <div class="kpi"><div class="kpi-lbl">Total Hours</div><div class="kpi-val">${Math.round(totalHrs)}h</div><div class="kpi-sub">relationship time</div></div>
    <div class="kpi"><div class="kpi-lbl">Meetings</div><div class="kpi-val">${totalMtgs}</div><div class="kpi-sub">external meetings</div></div>
    <div class="kpi"><div class="kpi-lbl">Active (90d)</div><div class="kpi-val">${vis.filter(a=>a.mtgs_90d>0).length}</div><div class="kpi-sub">orgs with recent activity</div></div>
  </div>

  <div class="grid2">
    <div class="panel">
      <div class="ph"><span class="pt">Hours by segment</span></div>
      <div class="pb">
        <table><thead><tr><th>Segment</th><th style="text-align:right">Hours</th><th style="text-align:right">Share</th></tr></thead>
        <tbody>${segRows(segHrs,'h')}</tbody></table>
      </div>
    </div>
    <div class="panel">
      <div class="ph"><span class="pt">Meetings by segment</span></div>
      <div class="pb">
        <table><thead><tr><th>Segment</th><th style="text-align:right">Meetings</th><th style="text-align:right">Share</th></tr></thead>
        <tbody>${segRows(segMtgs,'')}</tbody></table>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="ph"><span class="pt">Monthly hours (last 12 months)</span></div>
    <div class="pb">
      <div style="display:flex;align-items:flex-end;gap:4px;height:100px;padding-top:8px">${sparkBars}</div>
    </div>
  </div>

  <div class="panel">
    <div class="ph"><span class="pt">Top 20 accounts by hours</span></div>
    <div class="pb" style="padding:0">
      <table>
        <thead><tr>
          <th>Account</th><th>Domain</th><th>Hours</th>
          <th>Meetings</th><th>Status</th><th>Last Meeting</th>
        </tr></thead>
        <tbody>${top20rows}</tbody>
      </table>
    </div>
  </div>

  <div class="footer">Read-only snapshot ¬∑ data from ${USER_EMAIL}'s Google Calendar ¬∑ rel.intel v3</div>
</div>
</body></html>`;

  const blob = new Blob([html], {type:'text/html'});
  Object.assign(document.createElement('a'), {
    href: URL.createObjectURL(blob),
    download: `rel_intel_snapshot_${now.toISOString().slice(0,10)}.html`
  }).click();
  showToast('Snapshot downloaded ‚Äî open in any browser to share');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ACCOUNTS TABLE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setStatusFilter(val, btn) {
  statusFilter = val;
  document.querySelectorAll('[data-status]').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  clearSelection();
  renderAccounts();
}

function sortAccounts(key) {
  if (acctSortKey===key) acctSortDir*=-1;
  else { acctSortKey=key; acctSortDir=-1; }
  renderAccounts();
}

function visibleRows() {
  const q = (document.getElementById('acct-search').value||'').toLowerCase();
  return allAccounts.filter(a => {
    const status = tags[a.domain]?.status || 'unknown';
    if (q && !a.org.toLowerCase().includes(q) && !a.domain.includes(q)) return false;
    if (statusFilter==='all')      return status!=='ignore';
    if (statusFilter==='ignored')  return status==='ignore';
    if (statusFilter==='active90') return a.mtgs_90d>0 && status!=='ignore';
    return status===statusFilter;
  });
}

function renderAccounts() {
  const maxH = allAccounts.length ? allAccounts[0].hours_window : 1;
  let rows = visibleRows();
  rows.sort((a,b)=>{
    let av=a[acctSortKey], bv=b[acctSortKey];
    if (acctSortKey==='last_meeting'){av=av?.getTime()||0;bv=bv?.getTime()||0;}
    if (acctSortKey==='org'){av=av.toLowerCase();bv=bv.toLowerCase();}
    return (av>bv?-1:av<bv?1:0)*acctSortDir;
  });
  document.getElementById('acct-count').textContent = `${rows.length} accounts`;
  document.getElementById('acct-tbody').innerHTML = rows.map(a => {
    const t      = tags[a.domain]||{};
    const status = t.status||'unknown';
    const deal   = t.deal||'';
    const barW   = Math.round(a.hours_window/maxH*100);
    const sel    = selectedDomains.has(a.domain);
    return `<tr class="${sel?'selected':''} ${status==='ignore'?'row-ignored':''}">
      <td><input type="checkbox" class="row-check" ${sel?'checked':''} onchange="toggleRow('${a.domain}',this)"></td>
      <td>
        <div class="td-org"><span class="dot ${recency(a.last_meeting)}"></span>${a.org}</div>
        <div class="td-domain">${a.domain}</div>
      </td>
      <td><div class="bar-wrap">
        <div class="bar-track"><div class="bar-fill" style="width:${barW}%"></div></div>
        <span class="num-val">${a.hours_window}h</span>
      </div></td>
      <td><span class="num-val">${a.mtgs_window}</span></td>
      <td><span class="num-val ${a.hours_90d===0?'num-dim':''}">${a.hours_90d}h</span></td>
      <td><span class="num-val ${a.mtgs_90d===0?'num-dim':''}">${a.mtgs_90d}</span></td>
      <td><span class="num-val">${fmtDate(a.last_meeting)}</span></td>
      <td><span class="badge badge-${status}" onclick="cycleStatus('${a.domain}')">${status}</span></td>
      <td><input class="deal-input" type="text" value="${deal}" placeholder="e.g. $250k"
        onchange="setDeal('${a.domain}',this.value)" onclick="event.stopPropagation()"></td>
    </tr>`;
  }).join('');
  updateBulkBar();
}

/* ‚îÄ‚îÄ STATUS CYCLE (single row) ‚îÄ‚îÄ */
function cycleStatus(domain) {
  const t = tags[domain]||{};
  const cur = t.status||'unknown';
  const next = STATUS_CYCLE[(STATUS_CYCLE.indexOf(cur)+1)%STATUS_CYCLE.length];
  tags[domain] = {...t, status:next};
  saveTags(); renderAccounts(); renderSignals(); renderKPIs();
}

function setDeal(domain, val) {
  tags[domain] = {...(tags[domain]||{}), deal:val};
  saveTags(); renderSignals();
}

/* ‚îÄ‚îÄ BULK SELECT ‚îÄ‚îÄ */
function toggleRow(domain, cb) {
  if (cb.checked) selectedDomains.add(domain);
  else selectedDomains.delete(domain);
  updateBulkBar();
  // update row highlight without full re-render
  cb.closest('tr').classList.toggle('selected', cb.checked);
}

function toggleSelectAll(masterCb) {
  const rows = visibleRows();
  if (masterCb.checked) rows.forEach(a=>selectedDomains.add(a.domain));
  else selectedDomains.clear();
  renderAccounts();
}

function clearSelection() {
  selectedDomains.clear();
  const masterCb = document.getElementById('check-all');
  if (masterCb) masterCb.checked = false;
  renderAccounts();
}

function updateBulkBar() {
  const bar = document.getElementById('bulk-bar');
  const n = selectedDomains.size;
  document.getElementById('bulk-count').textContent = n;
  bar.classList.toggle('visible', n > 0);
}

function bulkSetStatus(status) {
  selectedDomains.forEach(domain => {
    tags[domain] = {...(tags[domain]||{}), status};
  });
  saveTags();
  clearSelection(); // clears selection and re-renders
  renderSignals(); renderKPIs();
  showToast(`${selectedDomains.size||'Selected'} accounts labelled as ${status}`);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SIGNALS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderSignals() {
  const vis = allAccounts.filter(a=>(tags[a.domain]?.status||'unknown')!=='ignore');

  const hot = vis.filter(a=>a.mtgs_90d>=3).slice(0,15);
  document.getElementById('hot-list').innerHTML = hot.length
    ? hot.map(a=>`<div class="signal-row hot">
        <div class="dot dot-hot" style="flex-shrink:0"></div>
        <div style="flex:1;min-width:0">
          <div class="signal-name">${a.org}</div>
          <div class="signal-domain">${a.domain}</div>
        </div>
        <div class="signal-stats"><strong>${a.mtgs_90d}</strong> mtgs ¬∑ <strong>${a.hours_90d}h</strong><br>Last: ${fmtDate(a.last_meeting)}</div>
      </div>`).join('')
    : '<div style="font-family:var(--mono);font-size:11px;color:var(--text3);padding:10px 0">No accounts with 3+ meetings in 90 days.</div>';

  const cold = vis.filter(a=>a.mtgs_window>=3&&a.mtgs_90d===0)
    .sort((a,b)=>b.hours_window-a.hours_window).slice(0,15);
  document.getElementById('cold-list').innerHTML = cold.length
    ? cold.map(a=>`<div class="signal-row cold">
        <div style="flex:1;min-width:0">
          <div class="signal-name">${a.org}</div>
          <div class="signal-domain">${a.domain}</div>
        </div>
        <div class="signal-stats"><strong>${a.mtgs_window}</strong> mtgs<br>Last: ${fmtDate(a.last_meeting)}</div>
      </div>`).join('')
    : '<div style="font-family:var(--mono);font-size:11px;color:var(--text3);padding:10px 0">No accounts gone cold.</div>';

  const pipeline = vis.filter(a=>tags[a.domain]?.deal)
    .sort((a,b)=>parseDeal(tags[b.domain]?.deal)-parseDeal(tags[a.domain]?.deal));
  const total = pipeline.reduce((s,a)=>s+parseDeal(tags[a.domain]?.deal),0);
  document.getElementById('pipeline-list').innerHTML = pipeline.length
    ? `<div style="font-family:var(--mono);font-size:11px;color:var(--text3);margin-bottom:12px">
        Total influenced: <span style="color:var(--green);font-size:13px">${fmtMoney(total)}</span> ¬∑ ${pipeline.length} accounts
       </div>
       ${pipeline.map(a=>{
         const status=tags[a.domain]?.status||'unknown';
         return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">
           <div style="flex:1"><span style="font-weight:500;font-size:12px">${a.org}</span>
             <span class="badge badge-${status}" style="margin-left:8px">${status}</span></div>
           <div style="font-family:var(--mono);font-size:12px;color:var(--green)">${fmtMoney(parseDeal(tags[a.domain]?.deal))}</div>
           <div style="font-family:var(--mono);font-size:10px;color:var(--text3)">${a.mtgs_window}m ¬∑ ${a.hours_window}h</div>
         </div>`;}).join('')}`
    : '<div style="font-family:var(--mono);font-size:11px;color:var(--text3)">No deals tagged. Add Deal $ on the Accounts tab to see pipeline here.</div>';
}

function parseDeal(str) {
  if (!str) return 0;
  const m=String(str).replace(/[$,\s]/g,'').match(/([\d.]+)([km]?)/i);
  if (!m) return 0;
  let n=parseFloat(m[1]);
  if (m[2].toLowerCase()==='k') n*=1000;
  if (m[2].toLowerCase()==='m') n*=1e6;
  return n;
}
function fmtMoney(n){
  if(n>=1e6) return '$'+(n/1e6).toFixed(1)+'M';
  if(n>=1000) return '$'+(n/1000).toFixed(0)+'K';
  return '$'+n.toFixed(0);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TRENDS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderTrends() {
  const last18=monthlyData.slice(-18);
  mkChart('ch-trend-mtgs',{type:'line',data:{
    labels:last18.map(d=>d.month.slice(2)),
    datasets:[{data:last18.map(d=>d.mtgs),borderColor:'#4f8ef7',backgroundColor:'rgba(79,142,247,0.08)',
      fill:true,tension:0.3,pointRadius:3,pointBackgroundColor:'#4f8ef7'}]
  },options:{...CD,scales:{x:{grid:{display:false},ticks:{...TK,maxRotation:45}},y:{grid:{color:'#181c22'},ticks:{...TK}}}}});

  mkChart('ch-trend-hrs',{type:'line',data:{
    labels:last18.map(d=>d.month.slice(2)),
    datasets:[{data:last18.map(d=>d.hours),borderColor:'#3ecf8e',backgroundColor:'rgba(62,207,142,0.06)',
      fill:true,tension:0.3,pointRadius:3,pointBackgroundColor:'#3ecf8e'}]
  },options:{...CD,scales:{x:{grid:{display:false},ticks:{...TK,maxRotation:45}},y:{grid:{color:'#181c22'},ticks:{...TK}}}}});

  const top15=allAccounts.filter(a=>(tags[a.domain]?.status||'unknown')!=='ignore').slice(0,15);
  const maxH=top15.length?top15[0].hours_window:1;
  document.getElementById('top15-bars').innerHTML=top15.map(a=>{
    const pF=(a.hours_window/maxH*100).toFixed(1);
    const p9=(a.hours_90d/maxH*100).toFixed(1);
    return `<div style="display:flex;align-items:center;gap:12px;margin-bottom:6px">
      <div style="width:130px;font-size:11px;color:var(--text2);text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${a.org}</div>
      <div style="flex:1;position:relative;height:14px;background:var(--bg3);border-radius:2px;overflow:hidden">
        <div style="height:100%;width:${pF}%;background:var(--border2);border-radius:2px"></div>
        <div style="position:absolute;top:0;left:0;height:100%;width:${p9}%;background:var(--accent);opacity:0.8;border-radius:2px"></div>
      </div>
      <div style="font-family:var(--mono);font-size:10px;color:var(--text3);white-space:nowrap;width:90px">${a.hours_window}h / ${a.mtgs_window}m</div>
    </div>`;
  }).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UTILITIES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function recency(dt){
  if(!dt)return 'dot-cold';
  const d=(new Date()-dt)/864e5;
  return d<=30?'dot-hot':d<=90?'dot-warm':'dot-cold';
}
function fmtDate(dt){
  if(!dt)return '‚Äî';
  return dt.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'2-digit'});
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CSV EXPORT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function exportCSV(){
  const hdr=['Account','Domain','Status','Deal $','Hours (window)','Meetings (window)','Hours (90d)','Meetings (90d)','Last Meeting','First Meeting'];
  const rows=allAccounts.map(a=>{
    const t=tags[a.domain]||{};
    return [a.org,a.domain,t.status||'unknown',t.deal||'',a.hours_window,a.mtgs_window,a.hours_90d,a.mtgs_90d,fmtDate(a.last_meeting),fmtDate(a.first_seen)]
      .map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',');
  });
  const blob=new Blob([[hdr.join(','),...rows].join('\n')],{type:'text/csv'});
  Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:`rel_intel_${new Date().toISOString().slice(0,10)}.csv`}).click();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GUIDE MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openGuide()  { document.getElementById('guide-modal').classList.add('open'); }
function closeGuide() { document.getElementById('guide-modal').classList.remove('open'); }
document.getElementById('guide-modal').addEventListener('click', function(e){ if(e.target===this)closeGuide(); });

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
loadConfig();
</script>
</body>
</html>
